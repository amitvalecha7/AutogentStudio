{% extends "base.html" %}

{% block title %}Knowledge Base - Autogent Studio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-brain me-2"></i>Knowledge Base
            </h2>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKnowledgeBaseModal">
                    <i class="fas fa-plus me-2"></i>Create Knowledge Base
                </button>
                <a href="{{ url_for('files') }}" class="btn btn-outline-primary">
                    <i class="fas fa-file-alt me-2"></i>Back to Files
                </a>
            </div>
        </div>
        
        <!-- Knowledge Base Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                        <h5>{{ knowledge_bases|length }}</h5>
                        <p class="text-muted mb-0">Knowledge Bases</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                        <h5>{{ knowledge_bases|sum(attribute='kb_files')|length }}</h5>
                        <p class="text-muted mb-0">Total Files</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <i class="fas fa-puzzle-piece fa-2x text-info mb-2"></i>
                        <h5>1.2K</h5>
                        <p class="text-muted mb-0">Total Chunks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-2x text-warning mb-2"></i>
                        <h5>Advanced</h5>
                        <p class="text-muted mb-0">RAG Enabled</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Knowledge Base Search -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-search me-2"></i>Search Knowledge Base
                </h5>
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchQuery" placeholder="Ask a question or search for information...">
                            <button class="btn btn-primary" onclick="searchKnowledgeBase()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="knowledgeBaseSelect">
                            <option value="">All Knowledge Bases</option>
                            {% for kb in knowledge_bases %}
                            <option value="{{ kb.id }}">{{ kb.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="searchResults" class="mt-3" style="display: none;">
                    <!-- Search results will be displayed here -->
                </div>
            </div>
        </div>
        
        <!-- Knowledge Bases List -->
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="mb-0">Your Knowledge Bases</h5>
            </div>
            <div class="card-body">
                {% if knowledge_bases %}
                    <div class="row">
                        {% for kb in knowledge_bases %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card bg-secondary border-0 h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title">{{ kb.name }}</h5>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" onclick="editKnowledgeBase({{ kb.id }})">Edit</a></li>
                                                <li><a class="dropdown-item" onclick="addFilesToKB({{ kb.id }})">Add Files</a></li>
                                                <li><a class="dropdown-item" onclick="exportKnowledgeBase({{ kb.id }})">Export</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" onclick="deleteKnowledgeBase({{ kb.id }})">Delete</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <p class="card-text text-muted">{{ kb.description or 'No description provided' }}</p>
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i class="fas fa-file-alt me-1"></i>{{ kb.kb_files|length }} files
                                            <i class="fas fa-cog ms-2 me-1"></i>{{ kb.embedding_model }}
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-primary" onclick="searchInKB({{ kb.id }})">
                                            <i class="fas fa-search me-1"></i>Search
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewKBFiles({{ kb.id }})">
                                            <i class="fas fa-eye me-1"></i>View Files
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <small class="text-muted">
                                        Updated {{ kb.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No knowledge bases yet</h4>
                        <p class="text-muted">Create your first knowledge base to get started with advanced RAG</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKnowledgeBaseModal">
                            <i class="fas fa-plus me-2"></i>Create Knowledge Base
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Knowledge Base Modal -->
<div class="modal fade" id="createKnowledgeBaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Create Knowledge Base</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createKnowledgeBaseForm">
                    <div class="mb-3">
                        <label for="kbName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="kbName" required>
                    </div>
                    <div class="mb-3">
                        <label for="kbDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="kbDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="embeddingModel" class="form-label">Embedding Model</label>
                        <select class="form-select" id="embeddingModel">
                            <option value="text-embedding-3-small">OpenAI text-embedding-3-small</option>
                            <option value="text-embedding-3-large">OpenAI text-embedding-3-large</option>
                            <option value="sentence-transformers">Sentence Transformers</option>
                            <option value="cohere">Cohere Embeddings</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="chunkSize" class="form-label">Chunk Size</label>
                                <input type="number" class="form-control" id="chunkSize" value="1000" min="100" max="4000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="chunkOverlap" class="form-label">Chunk Overlap</label>
                                <input type="number" class="form-control" id="chunkOverlap" value="200" min="0" max="500">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createKnowledgeBase()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Knowledge Base Files Modal -->
<div class="modal fade" id="kbFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Knowledge Base Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="kbFilesContent">
                    <!-- Files will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addMoreFiles()">Add More Files</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function searchKnowledgeBase() {
    const query = document.getElementById('searchQuery').value;
    const kbId = document.getElementById('knowledgeBaseSelect').value;
    
    if (!query.trim()) {
        showToast('Please enter a search query', 'warning');
        return;
    }
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    
    fetch('/api/knowledge-base/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            knowledge_base_id: kbId || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-info">No results found</div>';
            return;
        }
        
        let html = '<div class="search-results">';
        data.results.forEach((result, index) => {
            html += `
                <div class="card bg-secondary mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="card-title">Result ${index + 1}</h6>
                            <small class="text-muted">Score: ${result.similarity.toFixed(3)}</small>
                        </div>
                        <p class="card-text">${result.text}</p>
                        <small class="text-muted">From: ${result.file_name}</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        resultsDiv.innerHTML = html;
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
    });
}

function createKnowledgeBase() {
    const formData = {
        name: document.getElementById('kbName').value,
        description: document.getElementById('kbDescription').value,
        embedding_model: document.getElementById('embeddingModel').value,
        chunk_size: parseInt(document.getElementById('chunkSize').value),
        chunk_overlap: parseInt(document.getElementById('chunkOverlap').value)
    };
    
    if (!formData.name.trim()) {
        showToast('Please enter a name for the knowledge base', 'warning');
        return;
    }
    
    fetch('/files/knowledge-base/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Knowledge base created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createKnowledgeBaseModal')).hide();
            location.reload();
        } else {
            showToast('Error creating knowledge base: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating knowledge base: ' + error, 'error');
    });
}

function editKnowledgeBase(kbId) {
    showToast('Edit functionality coming soon!', 'info');
}

function addFilesToKB(kbId) {
    showToast('Add files functionality coming soon!', 'info');
}

function exportKnowledgeBase(kbId) {
    showToast('Export functionality coming soon!', 'info');
}

function deleteKnowledgeBase(kbId) {
    if (confirm('Are you sure you want to delete this knowledge base?')) {
        fetch(`/api/knowledge-base/${kbId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Knowledge base deleted successfully!', 'success');
                location.reload();
            } else {
                showToast('Error deleting knowledge base: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting knowledge base: ' + error, 'error');
        });
    }
}

function searchInKB(kbId) {
    document.getElementById('knowledgeBaseSelect').value = kbId;
    document.getElementById('searchQuery').focus();
}

function viewKBFiles(kbId) {
    fetch(`/api/knowledge-base/${kbId}/files`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('Error loading files: ' + data.error, 'error');
            return;
        }
        
        let html = '<div class="list-group">';
        data.files.forEach(file => {
            html += `
                <div class="list-group-item list-group-item-action bg-secondary">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${file.filename}</h6>
                            <small class="text-muted">${file.file_type} - ${(file.file_size / 1024).toFixed(2)} KB</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFileFromKB(${kbId}, ${file.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        document.getElementById('kbFilesContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('kbFilesModal')).show();
    })
    .catch(error => {
        showToast('Error loading files: ' + error, 'error');
    });
}

function removeFileFromKB(kbId, fileId) {
    if (confirm('Remove this file from the knowledge base?')) {
        fetch(`/api/knowledge-base/${kbId}/files/${fileId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('File removed from knowledge base!', 'success');
                viewKBFiles(kbId); // Refresh the list
            } else {
                showToast('Error removing file: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error removing file: ' + error, 'error');
        });
    }
}

function addMoreFiles() {
    bootstrap.Modal.getInstance(document.getElementById('kbFilesModal')).hide();
    window.location.href = '/files';
}

// Enter key handler for search
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchKnowledgeBase();
    }
});

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}
</script>
{% endblock %}
