{% extends "base.html" %}

{% block title %}Files - Autogent Studio{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 bg-secondary border-end">
            <div class="p-3 border-bottom">
                <h5 class="mb-0">
                    <i class="fas fa-folder me-2"></i>File Management
                </h5>
            </div>
            
            <div class="list-group list-group-flush">
                <a href="{{ url_for('files.files_index') }}" class="list-group-item list-group-item-action bg-secondary text-light active">
                    <i class="fas fa-file me-2"></i>All Files
                </a>
                <a href="{{ url_for('files.knowledge_base_index') }}" class="list-group-item list-group-item-action bg-secondary text-light">
                    <i class="fas fa-database me-2"></i>Knowledge Bases
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-secondary text-light">
                    <i class="fas fa-image me-2"></i>Images
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-secondary text-light">
                    <i class="fas fa-file-pdf me-2"></i>Documents
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-secondary text-light">
                    <i class="fas fa-file-audio me-2"></i>Audio
                </a>
                <a href="#" class="list-group-item list-group-item-action bg-secondary text-light">
                    <i class="fas fa-file-video me-2"></i>Video
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h4 class="mb-0">
                    <i class="fas fa-file me-2"></i>Files
                </h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="uploadFiles()">
                        <i class="fas fa-upload me-2"></i>Upload Files
                    </button>
                    <button class="btn btn-outline-primary" onclick="createKnowledgeBase()">
                        <i class="fas fa-database me-2"></i>Create Knowledge Base
                    </button>
                </div>
            </div>
            
            <!-- File Stats -->
            <div class="row p-3">
                <div class="col-md-3">
                    <div class="card bg-dark border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-file fa-2x text-primary mb-2"></i>
                            <h5 class="card-title">{{ files|length }}</h5>
                            <p class="card-text text-muted">Total Files</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-database fa-2x text-success mb-2"></i>
                            <h5 class="card-title">{{ knowledge_bases|length }}</h5>
                            <p class="card-text text-muted">Knowledge Bases</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-microchip fa-2x text-warning mb-2"></i>
                            <h5 class="card-title">{{ files|selectattr('is_processed')|list|length }}</h5>
                            <p class="card-text text-muted">Processed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-info">
                        <div class="card-body text-center">
                            <i class="fas fa-atom fa-2x text-info mb-2"></i>
                            <h5 class="card-title">Quantum</h5>
                            <p class="card-text text-muted">Enhanced</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="p-3 border-bottom">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" 
                                   placeholder="Search files..." onkeyup="searchFiles()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="fileTypeFilter" class="form-select bg-dark text-light border-secondary" onchange="filterFiles()">
                            <option value="">All Types</option>
                            <option value="pdf">PDF</option>
                            <option value="image">Images</option>
                            <option value="document">Documents</option>
                            <option value="audio">Audio</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="sortBy" class="form-select bg-dark text-light border-secondary" onchange="sortFiles()">
                            <option value="created_at">Date Created</option>
                            <option value="name">Name</option>
                            <option value="size">Size</option>
                            <option value="type">Type</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Files Grid -->
            <div class="p-3">
                <div id="filesGrid" class="row">
                    {% for file in files %}
                        <div class="col-md-4 mb-4 file-item" data-type="{{ file.file_type }}" data-name="{{ file.original_filename }}">
                            <div class="card bg-dark border-secondary h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="file-icon">
                                            {% if file.file_type == 'image' %}
                                                <i class="fas fa-image fa-2x text-primary"></i>
                                            {% elif file.file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf fa-2x text-danger"></i>
                                            {% elif file.file_type == 'document' %}
                                                <i class="fas fa-file-word fa-2x text-info"></i>
                                            {% elif file.file_type == 'audio' %}
                                                <i class="fas fa-file-audio fa-2x text-success"></i>
                                            {% elif file.file_type == 'video' %}
                                                <i class="fas fa-file-video fa-2x text-warning"></i>
                                            {% else %}
                                                <i class="fas fa-file fa-2x text-secondary"></i>
                                            {% endif %}
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end bg-dark">
                                                <li><a class="dropdown-item text-light" href="#" onclick="viewFile('{{ file.id }}')">
                                                    <i class="fas fa-eye me-2"></i>View
                                                </a></li>
                                                <li><a class="dropdown-item text-light" href="#" onclick="downloadFile('{{ file.id }}')">
                                                    <i class="fas fa-download me-2"></i>Download
                                                </a></li>
                                                <li><a class="dropdown-item text-light" href="#" onclick="processFile('{{ file.id }}')">
                                                    <i class="fas fa-cog me-2"></i>Process
                                                </a></li>
                                                <li><a class="dropdown-item text-light" href="#" onclick="addToKnowledgeBase('{{ file.id }}')">
                                                    <i class="fas fa-database me-2"></i>Add to KB
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteFile('{{ file.id }}')">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <h6 class="card-title text-truncate">{{ file.original_filename }}</h6>
                                    <p class="card-text text-muted small">
                                        {% if file.file_size %}
                                            Size: {{ (file.file_size / 1024)|round(1) }} KB<br>
                                        {% endif %}
                                        Type: {{ file.file_type|title }}<br>
                                        {% if file.is_processed %}
                                            <span class="badge bg-success">Processed</span>
                                        {% else %}
                                            <span class="badge bg-warning">Not Processed</span>
                                        {% endif %}
                                    </p>
                                    <small class="text-muted">{{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload Files
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="upload-area border-dashed border-secondary rounded p-5 text-center mb-3" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drag & Drop Files Here</h5>
                    <p class="text-muted">or click to select files</p>
                    <input type="file" id="fileInput" class="form-control bg-dark text-light border-secondary" 
                           multiple style="display: none;">
                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                        Select Files
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Processing Options</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="autoProcess" checked>
                        <label class="form-check-label" for="autoProcess">
                            Auto-process files for embeddings
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="neuromorphicEnhanced">
                        <label class="form-check-label" for="neuromorphicEnhanced">
                            Neuromorphic-enhanced processing
                        </label>
                    </div>
                </div>
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Uploading...</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleFileUpload()" disabled id="uploadBtn">
                    <i class="fas fa-upload me-2"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Knowledge Base Modal -->
<div class="modal fade" id="knowledgeBaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-database me-2"></i>Create Knowledge Base
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" id="kbName" class="form-control bg-dark text-light border-secondary" 
                           placeholder="Enter knowledge base name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="kbDescription" class="form-control bg-dark text-light border-secondary" 
                              rows="3" placeholder="Enter description"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Embedding Model</label>
                    <select id="embeddingModel" class="form-select bg-dark text-light border-secondary">
                        <option value="text-embedding-3-small">OpenAI Text Embedding 3 Small</option>
                        <option value="text-embedding-3-large">OpenAI Text Embedding 3 Large</option>
                        <option value="sentence-transformers">Sentence Transformers</option>
                        <option value="cohere">Cohere</option>
                        <option value="neuromorphic-enhanced">Neuromorphic Enhanced</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleKnowledgeBaseCreate()">
                    <i class="fas fa-plus me-2"></i>Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Viewer Modal -->
<div class="modal fade" id="fileViewerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="fileViewerTitle">
                    <i class="fas fa-file me-2"></i>File Viewer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fileViewerContent">
                    <!-- File content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // File management functions
    function uploadFiles() {
        const modal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
        modal.show();
    }
    
    function createKnowledgeBase() {
        const modal = new bootstrap.Modal(document.getElementById('knowledgeBaseModal'));
        modal.show();
    }
    
    function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const files = fileInput.files;
        
        if (files.length === 0) {
            alert('Please select files to upload');
            return;
        }
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        const progressDiv = document.getElementById('uploadProgress');
        progressDiv.style.display = 'block';
        
        fetch('/files/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Upload failed: ' + data.error);
            } else {
                alert('Files uploaded successfully!');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed');
        })
        .finally(() => {
            progressDiv.style.display = 'none';
            bootstrap.Modal.getInstance(document.getElementById('fileUploadModal')).hide();
        });
    }
    
    function handleKnowledgeBaseCreate() {
        const name = document.getElementById('kbName').value;
        const description = document.getElementById('kbDescription').value;
        const embeddingModel = document.getElementById('embeddingModel').value;
        
        if (!name) {
            alert('Please enter a name for the knowledge base');
            return;
        }
        
        fetch('/files/knowledge-base/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                name: name,
                description: description,
                embedding_model: embeddingModel
            })
        })
        .then(response => {
            if (response.ok) {
                alert('Knowledge base created successfully!');
                location.reload();
            } else {
                alert('Failed to create knowledge base');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create knowledge base');
        });
    }
    
    function viewFile(fileId) {
        fetch(`/files/${fileId}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('fileViewerContent').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
            modal.show();
        });
    }
    
    function downloadFile(fileId) {
        window.location.href = `/files/${fileId}/download`;
    }
    
    function processFile(fileId) {
        fetch(`/files/${fileId}/process`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Processing failed: ' + data.error);
            } else {
                alert('File processed successfully!');
                location.reload();
            }
        });
    }
    
    function deleteFile(fileId) {
        if (confirm('Are you sure you want to delete this file?')) {
            fetch(`/files/${fileId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Delete failed: ' + data.error);
                } else {
                    alert('File deleted successfully!');
                    location.reload();
                }
            });
        }
    }
    
    function searchFiles() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const fileItems = document.querySelectorAll('.file-item');
        
        fileItems.forEach(item => {
            const fileName = item.dataset.name.toLowerCase();
            if (fileName.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function filterFiles() {
        const filterType = document.getElementById('fileTypeFilter').value;
        const fileItems = document.querySelectorAll('.file-item');
        
        fileItems.forEach(item => {
            const fileType = item.dataset.type;
            if (!filterType || fileType === filterType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function sortFiles() {
        const sortBy = document.getElementById('sortBy').value;
        const filesGrid = document.getElementById('filesGrid');
        const fileItems = Array.from(document.querySelectorAll('.file-item'));
        
        fileItems.sort((a, b) => {
            // Simple sorting logic - in real implementation, use proper sorting
            const aValue = a.dataset[sortBy] || a.dataset.name;
            const bValue = b.dataset[sortBy] || b.dataset.name;
            return aValue.localeCompare(bValue);
        });
        
        fileItems.forEach(item => {
            filesGrid.appendChild(item);
        });
    }
    
    function handleDrop(event) {
        event.preventDefault();
        const files = event.dataTransfer.files;
        document.getElementById('fileInput').files = files;
        document.getElementById('uploadBtn').disabled = false;
    }
    
    function handleDragOver(event) {
        event.preventDefault();
    }
    
    // File input change handler
    document.getElementById('fileInput').addEventListener('change', function() {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = this.files.length === 0;
    });
</script>
{% endblock %}

